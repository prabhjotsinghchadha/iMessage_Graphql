"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _schema=require("@graphql-tools/schema");var _client=require("@prisma/client");var _server=require("@apollo/server");var _drainHttpServer=require("@apollo/server/plugin/drainHttpServer");var _express4=require("@apollo/server/express4");var _express=_interopRequireDefault(require("express"));var _graphqlSubscriptions=require("graphql-subscriptions");var _ws=require("graphql-ws/lib/use/ws");var _http=require("http");var _ws1=require("ws");var _react=require("next-auth/react");var _resolvers=_interopRequireDefault(require("./graphql/resolvers"));var _typeDefs=_interopRequireDefault(require("./graphql/typeDefs"));var _dotenv=_interopRequireWildcard(require("dotenv"));var _cors=_interopRequireDefault(require("cors"));var _bodyParser=require("body-parser");function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)})}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if(typeof WeakMap!=="function")return null;var cacheBabelInterop=new WeakMap;var cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(obj===null||typeof obj!=="object"&&typeof obj!=="function"){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={};var hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if(key!=="default"&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}var __generator=(void 0)&&(void 0).__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),"throw":verb(1),"return":verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e];y=0}finally{f=t=0}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true}}};var main=function(){var _ref=_asyncToGenerator(function(){var schema,app,httpServer,wsServer,prisma,pubsub,getSubscriptionContext,serverCleanup,server,corsOptions,PORT;return __generator(this,function(_state){switch(_state.label){case 0:_dotenv.config();schema=(0,_schema.makeExecutableSchema)({typeDefs:_typeDefs.default,resolvers:_resolvers.default});app=(0,_express.default)();httpServer=(0,_http.createServer)(app);wsServer=new _ws1.WebSocketServer({server:httpServer,path:"/graphql/subscriptions"});prisma=new _client.PrismaClient;pubsub=new _graphqlSubscriptions.PubSub;getSubscriptionContext=function(){var _ref=_asyncToGenerator(function(ctx){var session;return __generator(this,function(_state){ctx;if(ctx.connectionParams&&ctx.connectionParams.session){session=ctx.connectionParams.session;return[2,{session:session,prisma:prisma,pubsub:pubsub}]}return[2,{session:null,prisma:prisma,pubsub:pubsub}]})});return function getSubscriptionContext(ctx){return _ref.apply(this,arguments)}}();serverCleanup=(0,_ws.useServer)({schema:schema,context:function(ctx){return getSubscriptionContext(ctx)}},wsServer);server=new _server.ApolloServer({schema:schema,csrfPrevention:true,plugins:[(0,_drainHttpServer.ApolloServerPluginDrainHttpServer)({httpServer:httpServer}),{serverWillStart:function serverWillStart(){return _asyncToGenerator(function(){return __generator(this,function(_state){return[2,{drainServer:function drainServer(){return _asyncToGenerator(function(){return __generator(this,function(_state){switch(_state.label){case 0:return[4,serverCleanup.dispose()];case 1:_state.sent();return[2]}})})()}}]})})()}}]});return[4,server.start()];case 1:_state.sent();corsOptions={origin:process.env.BASE_URL,credentials:true};app.use("/graphql",(0,_cors.default)(corsOptions),(0,_bodyParser.json)(),(0,_express4.expressMiddleware)(server,{context:function(){var _ref=_asyncToGenerator(function(param){var req,session;return __generator(this,function(_state){switch(_state.label){case 0:req=param.req;return[4,(0,_react.getSession)({req:req})];case 1:session=_state.sent();return[2,{session:session,prisma:prisma,pubsub:pubsub}]}})});return function(_){return _ref.apply(this,arguments)}}()}));PORT=process.env.PORT;return[4,new Promise(function(resolve){return httpServer.listen({port:PORT},resolve)})];case 2:_state.sent();console.log("Server is now running on http://localhost:".concat(PORT,"/graphql"));return[2]}})});return function main(){return _ref.apply(this,arguments)}}();main().catch(function(err){return console.log(err)});