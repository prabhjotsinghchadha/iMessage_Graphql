"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _export(target,all){for(var name in all)Object.defineProperty(target,name,{enumerable:true,get:all[name]})}_export(exports,{messagePopulated:function(){return messagePopulated},default:function(){return _default}});var _client=require("@prisma/client");var _graphql=require("graphql");var _graphqlSubscriptions=require("graphql-subscriptions");var _functions=require("../../util/functions");var _conversation=require("./conversation");function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)})}}var __generator=(void 0)&&(void 0).__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),"throw":verb(1),"return":verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e];y=0}finally{f=t=0}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true}}};var resolvers={Query:{messages:function(){var _ref=_asyncToGenerator(function(_,args,context){var session,prisma,conversationId,_session_user,userId,conversation,allowedToView,messages,error;return __generator(this,function(_state){switch(_state.label){case 0:session=context.session,prisma=context.prisma;conversationId=args.conversationId;if(!(session===null||session===void 0?void 0:session.user)){throw new _graphql.GraphQLError("Not Authorized")}_session_user=session.user,userId=_session_user.id;return[4,prisma.conversation.findUnique({where:{id:conversationId},include:_conversation.conversationPopulated})];case 1:conversation=_state.sent();if(!conversation){throw new _graphql.GraphQLError("Conversation Not Found")}allowedToView=(0,_functions.userIsConversationParticipant)(conversation.participants,userId);if(!allowedToView){throw new _graphql.GraphQLError("Not Authorized")}_state.label=2;case 2:_state.trys.push([2,4,,5]);return[4,prisma.message.findMany({where:{conversationId:conversationId},include:messagePopulated,orderBy:{createdAt:"desc"}})];case 3:messages=_state.sent();return[2,messages];case 4:error=_state.sent();console.log("messages error",error);throw new _graphql.GraphQLError(error===null||error===void 0?void 0:error.message);case 5:return[2]}})});return function(_,args,context){return _ref.apply(this,arguments)}}()},Mutation:{sendMessage:function(){var _ref=_asyncToGenerator(function(_,args,context){var session,prisma,pubsub,messageId,senderId,conversationId,body,_session_user,userId,newMessage,participant,conversation,error;return __generator(this,function(_state){switch(_state.label){case 0:session=context.session,prisma=context.prisma,pubsub=context.pubsub;messageId=args.id,senderId=args.senderId,conversationId=args.conversationId,body=args.body;if(!(session===null||session===void 0?void 0:session.user)){throw new _graphql.GraphQLError("Not Authorized")}_session_user=session.user,userId=_session_user.id;if(userId!==senderId){throw new _graphql.GraphQLError("Not Authorized")}_state.label=1;case 1:_state.trys.push([1,5,,6]);return[4,prisma.message.create({data:{id:messageId,senderId:senderId,conversationId:conversationId,body:body},include:messagePopulated})];case 2:newMessage=_state.sent();return[4,prisma.conversationParticipant.findFirst({where:{userId:userId,conversationId:conversationId}})];case 3:participant=_state.sent();if(!participant){throw new _graphql.GraphQLError("participant does not exist")}return[4,prisma.conversation.update({where:{id:conversationId},data:{latestMessageId:newMessage.id,participants:{update:{where:{id:participant.id},data:{hasSeenLatestMessage:true}},updateMany:{where:{NOT:{userId:userId}},data:{hasSeenLatestMessage:false}}}},include:_conversation.conversationPopulated})];case 4:conversation=_state.sent();console.log(conversation);pubsub.publish("MESSAGE_SENT",{messageSent:newMessage});return[3,6];case 5:error=_state.sent();console.log("sendMessage error",error);throw new _graphql.GraphQLError("Error sending message");case 6:return[2,true]}})});return function(_,args,context){return _ref.apply(this,arguments)}}()},Subscription:{messageSent:{subscribe:(0,_graphqlSubscriptions.withFilter)(function(_,__,context){var pubsub=context.pubsub;return pubsub.asyncIterator(["MESSAGE_SENT"])},function(payload,args){return payload.messageSent.conversationId===args.conversationId})}}};var messagePopulated=_client.Prisma.validator()({sender:{select:{id:true,username:true}}});var _default=resolvers;